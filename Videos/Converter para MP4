#!/bin/bash

{
readarray FILENAME <<< "$(echo -e "$NAUTILUS_SCRIPT_SELECTED_FILE_PATHS" | sed -e 's/\r//g')"

for file in "${FILENAME[@]}"; do
    file=$(echo "$file" | tr -d $'\n')
    if file "$file" | grep -qE 'video|media'; then
        # Obter duração total do vídeo
        duration=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$file")
        
        # Converter com barra de progresso
        ffmpeg -i "$file" -c:v copy -c:a copy "${file%.*}-converted.mp4" 2>&1 | \
        while read -r line; do
            if [[ $line =~ time=([0-9:.]+) ]]; then
                current_time=$(echo "${BASH_REMATCH[1]}" | awk -F: '{ print ($1 * 3600) + ($2 * 60) + $3 }')
                progress=$(( (current_time * 100) / duration ))
                echo "$progress"
            fi
        done | zenity --progress \
            --title="Convertendo Vídeo" \
            --text="Convertendo $file..." \
            --percentage=0 \
            --auto-close
    else
        notify-send "Erro" "O arquivo $file não é um vídeo." --app-name="Conversor"
        exit 1
    fi
done

notify-send "Deu certo!" "Os arquivos foram convertidos para MP4." --app-name="Conversor"
}
